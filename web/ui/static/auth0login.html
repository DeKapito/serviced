<html>
  <head>
    <meta charset="utf-8">
    <title>Zenoss Cloud Auth</title>
  </head>
  <body>
  Hi there!

  <p>Parsed Hash:</p>
  <p id = "phash"></p>

  <p>Access Token:</p>
  <p id = "accesstoken">TBD</p>
  <p>ID Token:</p>
  <p id = "idtoken">TBD</p>

  <p>Expires In:</p>
  <p id = "expiry">TBD</p>

  <p>Status:</p>
  <p id = "status">TBD</p>


  <script src="https://cdn.auth0.com/js/auth0/9.3.1/auth0.min.js"></script>

  <script>
      debugger;
      const auth0 = window.auth0;
      var webAuth = new auth0.WebAuth({
          domain: 'zenoss-dev.auth0.com',
          clientID: 'xQF6jCIx6ZynvlvzT8ZWWrbOswcgCwH9',
          audience: 'https://dev.zing.ninja',
          scope: 'openid profile read:messages'
      });


      function setCookie(key, value, exseconds) {
          var d = new Date();
          d.setTime(d.getTime() + (exseconds * 1000));
          var expires = "expires="+d.toUTCString();
          document.cookie = key + "=" + value + ";" + expires + ";path=/";
      }

      function setLogin(authResult) {
          if (authResult && authResult.accessToken && authResult.idToken && authResult.expiresIn) {
              // debugger;
              setCookie("ZCPToken", authResult.accessToken, authResult.expiresIn);
              setCookie("ZUsername", "zenny", authResult.expiresIn);
          }
      }

      // function post shamelessly borrowed from https://stackoverflow.com/a/133997
      function post(path, params, method) {
          method = method || "post"; // Set method to post by default if not specified.

          // The rest of this code assumes you are not using a library.
          // It can be made less wordy if you use one.
          var form = document.createElement("form");
          form.setAttribute("method", method);
          form.setAttribute("action", path);

          for(var key in params) {
              if(params.hasOwnProperty(key)) {
                  var hiddenField = document.createElement("input");
                  hiddenField.setAttribute("type", "hidden");
                  hiddenField.setAttribute("name", key);
                  hiddenField.setAttribute("value", params[key]);

                  form.appendChild(hiddenField);
              }
          }

          document.body.appendChild(form);
          form.submit();
      }

      function loginToCC(data) {
          var url = "/auth0login"
          var json = JSON.stringify(data)
          var xhr = new XMLHttpRequest();
          xhr.open("POST", url, true);
          xhr.setRequestHeader('Content-type','application/json; charset=utf-8');
          xhr.onload = function () {
              var result = JSON.parse(xhr.responseText);
              if (xhr.readyState == 4 && (xhr.status == "201" || xhr.status == "200")) {
                  //success - update page w/result
                  console.table(result);
                  //debugger;
                  if (result && result.Detail && result.Detail == "Accepted") {
                      window.location.replace('/#/apps');
                  } else {
                      window.location.replace('/challenge');
                  }
              } else {
                //debugger
                  // error handling
                  // console.error(result);
              }
          }
          xhr.send(json);
      }


      function handleAuth(err, authResult) {
          if (err) {
              //this.clearAuthState()

              document.getElementById("status").innerHTML = "ERROR: " + err;
              return false
          } else if (authResult && authResult.accessToken && authResult.idToken && authResult.expiresIn) {
              //this.setAuthState(authResult)
              document.getElementById("phash").innerHTML = JSON.stringify(authResult);
              document.getElementById("accesstoken").innerHTML = authResult.accessToken;
              document.getElementById("idtoken").innerHTML = authResult.idToken;
              document.getElementById("expiry").innerHTML = authResult.expiresIn;
              location.hash = "";
              // debugger;
              // window.location.replace('/#/apps');
              loginToCC(authResult);
              // post("/auth0login", {
              //     accessToken: authResult.accessToken,
              //     idToken: authResult.idToken,
              //     expiresIn: authResult.expiresIn,
              // });
              setLogin(authResult);
              return true
          }
          return false
      }

      webAuth.parseHash(handleAuth);
  </script>
  </body>
</html>

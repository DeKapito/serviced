<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2014">
<meta name="DC.rights.owner" content="(C) Copyright 2014">
<meta name="DC.Type" content="task">
<meta name="prodname" content="Control Center">
<meta name="version" content="0">
<meta name="release" content="8">
<meta name="modification" content="0">
<meta name="DC.Publisher" content="Zenoss, Inc.">
<meta name="DC.Format" content="XHTML">
<meta name="DC.Identifier" content="taskid">
<link rel="stylesheet" type="text/css" href="../commonltr.css">
<title>Reducing high load averages on AWS hosts</title>
</head>
<body id="taskid">


  <h1 class="title topictitle1">Reducing high load averages on AWS hosts</h1>

  <div class="body taskbody">
    <div class="section context">
      <p class="p">When Docker is using the <samp class="ph codeph">devicemapper</samp> storage driver, a <span class="ph">Control Center</span> instance on an Amazon Web Services host may experience persistent,
        high averages for CPU load.</p>

      <p class="p">To diagnose and remedy this condition, perform this procedure.</p>

    </div>

    <ol class="ol steps"><li class="li step stepexpand">
        <span class="ph cmd">Log in to the master host or a resource pool host as a user with
          <span class="keyword cmdname">sudo</span> and <span class="keyword cmdname">docker</span> privileges.</span>
      </li>
<li class="li step stepexpand">
        <span class="ph cmd">Display information about Docker.</span>
        <div class="itemgroup stepxmp"><pre class="pre codeblock">sudo docker info | grep -A 2 'Storage Driver:'</pre>
</div>
        <div class="itemgroup info">Sample
          output:<pre class="pre codeblock">Storage Driver: devicemapper
 Root Dir: /var/lib/docker/devicemapper
 Dirs: 21</pre>

        </div>
        <ul class="ul choices">
          <li class="li choice">If the storage driver is <samp class="ph codeph">devicemapper</samp>, continue this procedure.</li>

          <li class="li choice">If the storage driver is not <samp class="ph codeph">devicemapper</samp>, stop this procedure
            The cause of high load averages lies elsewhere.</li>

        </ul>

      </li>
<li class="li step stepexpand">
        <span class="ph cmd">Stop the <span class="keyword cmdname">serviced</span> and <span class="keyword cmdname">docker</span> daemons, in order.</span>
        <div class="itemgroup stepxmp"><pre class="pre codeblock">sudo stop serviced; sudo stop docker</pre>
</div>
      </li>
<li class="li step stepexpand">
        <span class="ph cmd">Create a variable for the Docker defaults file on your platform.</span>
        <ul class="ul choices">
          <li class="li choice">RHEL/CentOS hosts: <kbd class="ph userinput">DEFAULTS=/etc/sysconfig/docker</kbd></li>

          <li class="li choice">Ubuntu hosts: <kbd class="ph userinput">DEFAULTS=/etc/default/docker</kbd></li>

        </ul>

      </li>
<li class="li step stepexpand">
        <span class="ph cmd">Edit the Docker defaults file.</span>
        <div class="itemgroup info">The DOCKER_OPTS variable specifies startup options for the <span class="keyword cmdname">docker</span>
          daemon.</div>
        <div class="itemgroup stepxmp"><pre class="pre codeblock">grep '^[^#]*DOCKER_OPTS' $DEFAULTS</pre>
</div>
        <ul class="ul choices">
          <li class="li choice">
            <p class="p">If the preceding command returns a result, add the required option to the existing
              options.</p>

            <pre class="pre codeblock">newopt='--storage-opt dm.blkdiscard=false' 
opt=$(grep '^[^#]*DOCKER_OPTS' $DEFAULTS)
opt=${opt#*=}; optqc=${opt:0:1}; optlen=${#opt}
opt=${opt:1:($optlen-2)}
MYOPT="${optqc}${opt} ${newopt}${optqc}"
sudo sed -i -e \
  's|^[^#]*DOCKER_OPTS=.*$|DOCKER_OPTS='"${MYOPT}"'|' $DEFAULTS</pre>

          </li>

          <li class="li choice">
            <p class="p">If the preceding command does not return a result, define the DOCKER_OPTS variable
              with the required option.</p>

            <pre class="pre codeblock">MYOPT='\nDOCKER_OPTS="--storage-opt dm.blkdiscard=false"'
sudo sed -i -e '/^#DOCKER_OPTS=/ s|$|'"${MYOPT}"'|' $DEFAULTS</pre>

          </li>

        </ul>

      </li>
<li class="li step stepexpand">
        <span class="ph cmd">Start the <span class="keyword cmdname">docker</span> and <span class="keyword cmdname">serviced</span> daemons, in order.</span>
        <div class="itemgroup stepxmp"><pre class="pre codeblock">sudo start docker; sudo start serviced</pre>
</div>
      </li>
</ol>

  </div>


</body>
</html>